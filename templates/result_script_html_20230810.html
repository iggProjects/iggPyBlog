{% extends 'layout.html' %}

{% block body %}

    <h1 style= "margin-left:11%; font-size:22px;">PY CLIENT SUBPROCESS FOR&nbsp;&nbsp;&nbsp;==> "{{py_name}}"</h1>
    <div id="div_matrix" style="max-width:80%; max-height:75vh; margin:auto; padding: 20px; padding-top: 0px; text-align: center; overflow-y:scroll; direction: ltr; border:10px solid rgb(128, 106, 252); border-radius: 10px; ">
    <!-- <div id="div_matrix" style="max-width:80%; max-height:75vh; margin:auto; padding: 20px; padding-top: 0px; text-align: center; overflow-y:auto; display: flex; flex-direction: column-reverse; border:10px solid rgb(128, 106, 252); border-radius: 10px;"> -->
    <!-- <div id="div_matrix" style="max-width:80%; max-height:75vh; margin:auto; padding: 20px; padding-top: 0px; text-align: center; overflow-y:scroll; border:10px solid rgb(128, 106, 252); border-radius: 10px; background-color: rgb(8, 8, 124); ">  -->
    <!--        
    {% for line in list_lines %}
        <p class="p_result" style='color:{{line[0]}}'>{{ line[1] }}</p>
    {% endfor %}
    -->
    
    </div>

    <script type="text/javascript">

        /* <span> for '1' */
        function span_ones(line){
            span_line="";
            
            for ( j=0; j<line.length; j++ ){
                if (line[j] == 1) {
                    span_line += "<span> 1</span>";
                } else if (line[j] == 0) {
                    span_line += " " + line[j];
                } else if (line[j] == 9) {
                    span_line += "&nbsp;";    
                } else {
                    span_line += " " + line[j];
                }
            }
            // console.log("=== FROM span_ones, length of span_line: " + span_line.length); 
            // console.log("=== FROM span_ones, span_line: " + span_line); 
            return span_line;
        }

        /* <span> for '1' */
        function span_ones_2(line){
            span_line="";
            
            for ( j=0; j<line.length; j++ ){
                if (line[j] == 0) {
                    span_line += "<span class='span0'>0</span>";
                } else if (line[j] == 1) {
                    span_line += "<span class='span1'>1</span>";
                } else if (line[j] == 'x') {
                    span_line += "<span class='span9'>&nbsp;&nbsp;</span>";
                } else if (line[j] == '9') {
                    span_line += "<span class='span9'>9</span>";   
                } else {
                    span_line += "<span class='span9'>?</span>";
                }
            }
            // console.log("=== FROM span_ones, length of span_line: " + span_line.length); 
            // console.log("=== FROM span_ones, span_line: " + span_line); 
            return span_line;
        }


        // read server data JS as array
        var lines = {{ list_JS_lines | tojson }};
        console.log('type of lines[0] var: ' + typeof(lines[0]));
        console.log('type of lines[0] var: ' + Object.prototype.toString.call(lines[0]));
        console.log('Length of lines var: ' + lines.length);

        var lines_col_txt = {{ list_lines | tojson }};        
        console.log('type of lines_col_txt[0] var: ' + typeof(lines_col_txt[0]));
        console.log('type of lines_col_txt[0] var: ' + Object.prototype.toString.call(lines_col_txt[0]));
        console.log('Length of lines_col_txt var: ' + lines_col_txt.length);
        console.log('color: ' + lines_col_txt[0][0] + ' | text: ' + lines_col_txt[0][1])

        /* variables  */  
        div_matrix_html = "";
        list_matrices = [];
        matrix = [];
        comment = false;        

        if ( lines[0].toLowerCase().includes("matriz") || lines[0].toLowerCase().includes("iter") || lines[0].toLowerCase().includes("starting")) {
                 
            document.getElementById("div_matrix").style.backgroundColor = "blue";

            // create array for all matrices
            for (i=0; i < lines.length; i++) {
                // console.log('===> list line ' + i + ' -- ' + lines[i])            
                if ( lines[i][0] == 'M' || lines[0].toLowerCase().includes("starting")) {                      
                    matrix = []
                    // div_matrix_html += "<br><p class='p_result' style='color:yellow;'>" + lines[i] + "</p>";
                    matrix.push(lines[i])     
                    console.log('Starting ===> ' + lines[i])          
                
                } else if ( lines[i][0] == 'I' ) { 
                    //console.log('matrix ===> ' + matrix)        
                    list_matrices.push(matrix)
                    matrix = []                    
                    // div_matrix_html = "<br><p class='p_result' style='color:yellow;'>" + lines[i] + "</p>";  
                    matrix.push(lines[i])
                    console.log('matrix ===> I ' + lines[i])          

                } else if ( lines[i][0] == 0 || lines[i][0] == 1 || lines[i][0] == 9 ) {    
                    // div_matrix_html += "<p class='p_result'>" + span_ones(lines[i]) + "</p>";   
                    if ( comment ) {
                        console.log('COMMENT ' + lines[i])          
                        list_matrices.push(matrix);
                        comment = false;
                        matrix = [];
                        matrix.push(lines[i]);                        
                    } else if ( !comment ) {
                        matrix.push(lines[i]);     
                    }
                    else { 
                        console.log("=== from lines in result_script_html.html: SOS ! ")
                    }
                    //console.log('matrix ===> 0,1,9 ' + matrix)          

                } else if ( lines[i].toLowerCase().includes("comment") ) {
                    // lines[i]=lines[i].replace('COMMENT','&nbsp;&nbsp;&nbsp;&nbsp;')
                    matrix.push(lines[i]);
                    comment = true;

                } else if ( lines[i][0] == 'E' ) {      
                    list_matrices.push(matrix)   
                    //div_matrix_html += "<br><p class='p_result' style='color:yellow;'>" + lines[i] + "</p>";
                    console.log('matrix ===> E ' + lines[i])  

                } else {                    
                    console.log('lines[i][0] ===> ' + lines[i][0])
                }
            }

            list_matrices.push(matrix)   

        } else {
            /* replace 'COMMENT' with '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'  */
            for ( i=0; i<lines_col_txt.length; i++) {
                /*
                if ( lines_col_txt[i][1][0] == 0 || lines_col_txt[i][1][0] == 1 || lines_col_txt[i][1][0] == 9 ) {
                    lines_col_txt[i][1] = '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' +  lines_col_txt[i][1]
                }
                */
                lines_col_txt[i][1]=lines_col_txt[i][1].replace('COMMENT:','COMMENT:&nbsp;&nbsp;')
                //lines_col_txt[i][1]=lines_col_txt[i][1].replace('COMMENT:','&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;===> ')
                //console.log('lines_col_txt[' + i + '][1]: ' + lines_col_txt[i][1])
            }

            list_matrices.push(lines_col_txt);
            document.getElementById("div_matrix").style.backgroundColor = "#b3ffd9";
        }    

        console.log('list_matrices===> ' + list_matrices.length)

        // call function to print list_matrices with delay
        let k = 0;        
        let k_max = list_matrices.length; 
        console.log('k is: ' + k + ' | k_max is: ' + k_max);
        div_html = "";
        matrix = [];
        //const words= ['w1111111','w222','w333','w444','w1111111','w222','w333','w1111111','w222','w333','w1111111','w222','w333'];

        blank_line =[]

        /* CHECK IF ''list_matrices.length' TO DEFINE 'setInterval' option */

        if ( k_max > 1 ) {  // background response must be work like list of number matrices 

            iter = setInterval(print_html_MATRIX,500);

            function print_html_MATRIX() {
                div_html =  "";
                document.getElementById("div_matrix").innerHTML = "";
                matrix = list_matrices[k];     
                // console.log("=== list_matrices[k]" + list_matrices[k])       
                for ( var l=0; l < matrix.length; l++ ) {
                    //console.log(' ===> matrix line ' + l + ' --> ' + matrix[l])
                    if ( matrix[l][0] == 'M' || matrix[l][0] == 'I' ) {  
                        div_html += "<br><p class='p_result' style='color:yellow;'>" + matrix[l] + "</p>";
                    
                    } else if ( matrix[l][0] == 0 || matrix[l][0] == 1) {
                        div_html += "<p class='p_result'>" + span_ones(matrix[l]) + "</p>";

                    } else if ( matrix[l][0] == 9 ) {
                        /*
                        for (m=0; m < matrix[l].length; m++) {
                            blank_line+="&nbsp;";
                        } 
                        */   
                        div_html += "<p class='p_result'>&nbsp;&nbsp;&nbsp;&nbsp;</p>";    
                    } else {
                        // console.log('==> matrix[l]' + matrix[l])
                        if ( ( matrix[l][1][0] == 0 || matrix[l][1][0] == 1 || matrix[l][1][0] == 9 ) && matrix[l][1][1] != '|' ) {
                            div_html += "<p class='p_result'>" + span_ones_2(matrix[l][1]) + "</p>";    
                        } else if ( matrix[l][1][0] == '-' ) {
                            div_html += "<p class='p_result' style='height:3px; color:transparent;'>" + matrix[l][1] + "</p>";
                            // div_html += "<p class='p_result' style='color: " + matrix[l][0]  + "'>" + matrix[l][1] + "</p>";
                        } else {
                            div_html += "<p class='p_result' style='text-align: left; color: " + matrix[l][0]  + "'>" + matrix[l][1] + "</p>";
                        }
                    }  
                }

                // document.getElementById("test").innerHTML = words[k];
                document.getElementById("div_matrix").innerHTML = div_html;
                k++;
                // console.log('k is: ' + k + ' | k_max is: ' + k_max);
                if ( k >= k_max ) {                     
                    clearInterval(iter);
                }
            }

        } else if ( k_max ==1 ) {   // background response must be work like list of text lines 

            //total_lines= list_matrices[0].length
            /* Printing line by line with small delay*/
            iter = setInterval(print_html_LINE,100);

            /*  change height attribute of getElementById("div_matrix") to expand as lines comes */

            function print_html_LINE() {
                
                // to see as lines comes
                document.getElementById("div_matrix").scrollIntoView(false);
                // window.scrollTo(0,document.getElementById("div_matrix").offsetHeight);
                //document.getElementById("div_matrix").scrollHeight;

                console.log("=== list_matrices[0]" + list_matrices[0])   

                div_html += "<p class='p_result' style='text-align: left; color: " + list_matrices[0][k][0]  + "'>" + list_matrices[0][k][1] + "</p>";
 
                document.getElementById("div_matrix").innerHTML = div_html;
                k++;
                
                if ( k >= list_matrices[0].length ) {                     
                    clearInterval(iter);
                }
            }
                
        } else {
            // UPSSSSSSSS SOMTHING WRONG !!!
        }

    


        
    </script>

{% endblock %}